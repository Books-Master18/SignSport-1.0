from flask import Flask, request, jsonify, render_template
import os

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–µ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤ –≤ Flask
os.environ["TOKENIZERS_PARALLELISM"] = "false"

# –°–ø–∏—Å–æ–∫ –≤–∏–¥–æ–≤ —Å–ø–æ—Ä—Ç–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏, –∏ –¥–ª—è zero-shot
SPORT_CATEGORIES = [
    "–§—É—Ç–±–æ–ª", "–ì–∞–Ω–¥–±–æ–ª", "–í–æ–¥–Ω–æ–µ –ø–æ–ª–æ", "–í–æ–ª–µ–π–±–æ–ª", "–ü–ª–∞–≤–∞–Ω–∏–µ",
    "–§–∏–≥—É—Ä–Ω–æ–µ –∫–∞—Ç–∞–Ω–∏–µ", "–¢—è–∂–µ–ª–∞—è –∞—Ç–ª–µ—Ç–∏–∫–∞", "–¢–µ–Ω–Ω–∏—Å",
    "–•–æ–∫–∫–µ–π", "–§–µ—Ö—Ç–æ–≤–∞–Ω–∏–µ", "–ê–∫—Ä–æ–±–∞—Ç–∏–∫–∞", "–®–∞—Ö–º–∞—Ç—ã", "–ë–æ–∫—Å"
]

print("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...")
classifier = None
MODEL_READY = False

try:
    from transformers import pipeline

    # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –ø–∞–ø–∫–µ signsport-model/)
    if os.path.exists("signsport-model") and os.path.isdir("signsport-model"):
        classifier = pipeline("text-classification", model="signsport-model")
        MODEL_READY = True
        print("‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ–æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∏–∑ –ø–∞–ø–∫–∏ 'signsport-model'")
    else:
        # Fallback: –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è zero-shot –º–æ–¥–µ–ª—å (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π!)
        print("‚ö†Ô∏è –î–æ–æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ó–∞–≥—Ä—É–∑–∫–∞ –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ–π zero-shot –º–æ–¥–µ–ª–∏...")
        classifier = pipeline(
            "zero-shot-classification",
            model="MoritzLaurer/mDeBERTa-v3-base-xnli-multilingual-nli"
        )
        MODEL_READY = True
        print("‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è zero-shot –º–æ–¥–µ–ª—å (—Ä—É—Å—Å–∫–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)")

except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏: {e}")
    MODEL_READY = False
    classifier = None

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
app = Flask(__name__)

@app.route('/')
def home():
    return render_template('SignSport-1.0.html')

@app.route('/analyze')
def analyze_page():
    return render_template('neural_network.html')

@app.route('/api/analyze', methods=['POST'])
def analyze_text():
    if not MODEL_READY or classifier is None:
        return jsonify({"error": "–ú–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ."}), 500

    try:
        data = request.get_json()
        text = data.get('text', '').strip()
        if not text:
            return jsonify({"error": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á—ë—Ç–∞."}), 400

        # –î–æ–æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å: –æ–∂–∏–¥–∞–µ—Ç –º–µ—Ç–∫–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
        if os.path.exists("signsport-model") and os.path.isdir("signsport-model"):
            result = classifier(text)
            sport = result[0]['label']
            confidence = round(result[0]['score'] * 100, 1)
        else:
            # Zero-shot: –ø–µ—Ä–µ–¥–∞—ë–º —Ä—É—Å—Å–∫–∏–µ –º–µ—Ç–∫–∏ –Ω–∞–ø—Ä—è–º—É—é
            result = classifier(text, candidate_labels=SPORT_CATEGORIES)
            sport = result['labels'][0]
            confidence = round(result['scores'][0] * 100, 1)

        # –ü–æ—è—Å–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞ —Å–ø–æ—Ä—Ç–∞
        REASONS = {
            "–§—É—Ç–±–æ–ª": "–û–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è, —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –ø–æ–±–µ–¥–µ –∏ –∫–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî –æ—Å–Ω–æ–≤–∞ —É—Å–ø–µ—Ö–∞ –≤ —Ñ—É—Ç–±–æ–ª–µ.",
            "–ì–∞–Ω–¥–±–æ–ª": "–≠–Ω–µ—Ä–≥–∏—á–Ω–æ—Å—Ç—å, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å, –ª–æ–≤–∫–æ—Å—Ç—å –∏ —É–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ –¥–µ–ª–∞—é—Ç –≥–∞–Ω–¥–±–æ–ª –∏–¥–µ–∞–ª—å–Ω—ã–º –≤—ã–±–æ—Ä–æ–º.",
            "–í–æ–¥–Ω–æ–µ –ø–æ–ª–æ": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ö–ª–∞–¥–Ω–æ–∫—Ä–æ–≤–∏–µ –≤ —Å—Ç—Ä–µ—Å—Å–µ, –≤—ã—Å–æ–∫–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –∏ —Ç–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.",
            "–í–æ–ª–µ–π–±–æ–ª": "–ë—ã—Å—Ç—Ä–æ—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å ‚Äî –æ—Å–Ω–æ–≤–∞ –≤–æ–ª–µ–π–±–æ–ª—å–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞.",
            "–ü–ª–∞–≤–∞–Ω–∏–µ": "–ò–Ω—Ç—Ä–æ–≤–µ—Ä—Å–∏—è, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –º–æ–Ω–æ—Ç–æ–Ω–∏–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç–º ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø–ª–∞–≤–∞–Ω–∏—è.",
            "–§–∏–≥—É—Ä–Ω–æ–µ –∫–∞—Ç–∞–Ω–∏–µ": "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ —Ä–∏—Ç—É–∞–ª–∞–º –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.",
            "–¢—è–∂–µ–ª–∞—è –∞—Ç–ª–µ—Ç–∏–∫–∞": "–°–∏–ª–∞ –≤–æ–ª–∏, —Ç–µ—Ä–ø–µ–ª–∏–≤–æ—Å—Ç—å, –º–µ—Ç–æ–¥–∏—á–Ω–æ—Å—Ç—å –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ –ª–∏—á–Ω–æ–µ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ ‚Äî –æ—Å–Ω–æ–≤–∞ —É—Å–ø–µ—Ö–∞.",
            "–¢–µ–Ω–Ω–∏—Å": "–≠–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è, —Ç–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –ø–æ–±–µ–¥–µ.",
            "–•–æ–∫–∫–µ–π": "–°–º–µ–ª–æ—Å—Ç—å, —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∫–æ–ª–ª–µ–∫—Ç–∏–≤–∏–∑–º –∏ —É–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —É—Å–ª–æ–≤–∏—è—Ö –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è.",
            "–§–µ—Ö—Ç–æ–≤–∞–Ω–∏–µ": "–ê–Ω–∞–ª–∏—Ç–∏—á–Ω–æ—Å—Ç—å, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, –±—ã—Å—Ç—Ä–æ—Ç–∞ —Ä–µ–∞–∫—Ü–∏–∏ –∏ —É–º–µ–Ω–∏–µ –ø—Ä–æ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ö–æ–¥—ã —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.",
            "–ê–∫—Ä–æ–±–∞—Ç–∏–∫–∞": "–ê—Ä—Ç–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –≤—ã—Å–æ–∫–∞—è –≤–µ—Å—Ç–∏–±—É–ª—è—Ä–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.",
            "–®–∞—Ö–º–∞—Ç—ã": "–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, –∞–Ω–∞–ª–∏—Ç–∏—á–Ω–æ—Å—Ç—å, —É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω–æ—Å—Ç—å –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –≥–ª—É–±–æ–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É.",
        }

        reason = REASONS.get(sport, "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –≤–∞—à–µ–º –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø—Ä–æ—Ñ–∏–ª–µ.")

        return jsonify({
            "success": True,
            "sport": sport,
            "confidence": confidence,
            "reason": reason
        })

    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        print(f"–û—à–∏–±–∫–∞ –≤ /api/analyze: {e}")
        return jsonify({"error": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–µ–∫—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."}), 500

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if __name__ == '__main__':
    print("\n" + "="*50)
    status = "‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!" if MODEL_READY else "‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!"
    print(f"üß† SignSport Neural Network ‚Äî {status}")
    print("üëâ –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:5000")
    print("="*50 + "\n")
    app.run(debug=True, host='0.0.0.0', port=5000)