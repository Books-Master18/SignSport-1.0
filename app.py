from flask import Flask, request, jsonify, render_template
from transformers import pipeline
import os

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
os.environ["TOKENIZERS_PARALLELISM"] = "false"

SPORT_PROFILES = {
    "–º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏": {
        "keywords": ["—Ç—Ä–µ–≤–æ–≥–∞", "–±–æ–∏—Ç—Å—è", "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ", "–≤–æ–ª–Ω—É–µ—Ç—Å—è", "—Å—Ç—Ä–∞—Ö", "–¥–µ—Ä–∂–∏—Ç—Å—è"],
        "sport": "–ô–æ–≥–∞, –ø–ª–∞–≤–∞–Ω–∏–µ",
        "reason": "–í–∞—à–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ø—Ä–∏ –≤–Ω–µ—à–Ω–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º –ø–æ–≤–µ–¥–µ–Ω–∏–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å CNT (–∫–æ–Ω—Ç—Ä–∞–∫—Ü–∏–∏). –≠—Ç–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç RLS (—Ä–µ–ª–∏–∑), —Å–Ω–∏–∂–∞—é—Ç —Ç–æ–Ω—É—Å –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –¥—ã—Ö–∞–Ω–∏–µ."
    },
    "–±–æ–µ–≤—ã–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞": {
        "keywords": ["–∑–ª–∏—Ç—Å—è", "–≤—Å–ø—ã–ª—å—á–∏–≤—ã–π", "–∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–π", "—ç–Ω–µ—Ä–≥–∏—è", "–Ω–µ —Å–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"],
        "sport": "–ë–æ–∫—Å, —Å–∫–∞–ª–æ–ª–∞–∑–∞–Ω–∏–µ, –∫–∞—Ä–∞—Ç–µ",
        "reason": "–í—ã—Å–æ–∫–∞—è —ç–∫—Å–ø—Ä–µ—Å—Å–∏—è –∏ –Ω–∏–∑–∫–∞—è —Å–∞–º–æ—Ä–µ–≥—É–ª—è—Ü–∏—è –≥–æ–≤–æ—Ä—è—Ç –æ –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞–¥ —Ñ–æ—Ä–º–æ–π. –ë–æ–µ–≤—ã–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é—Ç —ç–Ω–µ—Ä–≥–∏—é –∏ —Ä–∞–∑–≤–∏–≤–∞—é—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –≤ –¥–µ–π—Å—Ç–≤–∏–∏."
    },
    "–∫–æ–º–∞–Ω–¥–Ω—ã–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞": {
        "keywords": ["–æ–±—â–∞–µ—Ç—Å—è", "–æ—Ç–∫—Ä—ã—Ç—ã–π", "—ç–Ω–µ—Ä–≥–∏—è", "—Ä–∞–¥–æ—Å—Ç—å", "–∫–æ–º–∞–Ω–¥–∞", "–≤–º–µ—Å—Ç–µ"],
        "sport": "–§—É—Ç–±–æ–ª, —Ç–∞–Ω—Ü—ã, –≤–æ–ª–µ–π–±–æ–ª",
        "reason": "–í–∞—à–∞ —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è –∏ —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –≤ –Ω–∞–∫–ª–æ–Ω–µ –ø–æ—á–µ—Ä–∫–∞ –≤–ø—Ä–∞–≤–æ –∏ –≤—ã—Å–æ–∫–æ–π –≤–∏—Ç–∞–ª—å–Ω–æ—Å—Ç–∏. –°–æ–≤–º–µ—Å—Ç–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–∞—à—É –ø—Ä–∏—Ä–æ–¥–Ω—É—é –≥–∞—Ä–º–æ–Ω–∏—é."
    },
    "–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ –≤–∏–¥—ã": {
        "keywords": ["—Å–ø–æ–∫–æ–π–Ω—ã–π", "–∞–Ω–∞–ª–∏–∑", "–¥—É–º–∞–µ—Ç", "—Å—Ç—Ä—É–∫—Ç—É—Ä–∞", "–º–µ—Ç–æ–¥–∏—á–Ω—ã–π", "—É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω—ã–π"],
        "sport": "–®–∞—Ö–º–∞—Ç—ã, –≥–æ–ª—å—Ñ, –Ω–∞—Å—Ç–æ–ª—å–Ω—ã–π —Ç–µ–Ω–Ω–∏—Å",
        "reason": "–ë–ª–∞–≥–æ–ø–æ–ª—É—á–Ω–∞—è –º–∞–∫—Ä–æ- –∏ –º–∏–∫—Ä–æ—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —É–º–µ—Ä–µ–Ω–Ω—ã–π –Ω–∞–∂–∏–º –∏ —á—ë—Ç–∫–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –≥–æ–≤–æ—Ä—è—Ç –æ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏. –≠—Ç–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫."
    },
    "—Ä–∏—Ç–º–∏—á–Ω—ã–µ –∫–∞—Ä–¥–∏–æ–Ω–∞–≥—Ä—É–∑–∫–∏": {
        "keywords": ["—É—Å—Ç–∞–ª–æ—Å—Ç—å", "–∞–ø–∞—Ç–∏—è", "–ø–æ–¥–∞–≤–ª–µ–Ω", "–º–µ–¥–ª–µ–Ω–Ω—ã–π", "—ç–Ω–µ—Ä–≥–∏–∏ –Ω–µ—Ç"],
        "sport": "–ë–µ–≥, –≤–µ–ª–æ—Å–∏–ø–µ–¥, —Ö–æ–¥—å–±–∞",
        "reason": "–°–Ω–∏–∂–µ–Ω–Ω—ã–π —Ç–æ–Ω—É—Å –∏ –æ–±—Ä–∞—â—ë–Ω–Ω–æ—Å—Ç—å –≤–Ω—É—Ç—Ä—å (–º–µ–ª–∫–∏–π –ø–æ—á–µ—Ä–∫, —Å–ª–∞–±—ã–π –Ω–∞–∂–∏–º) —Ç—Ä–µ–±—É—é—Ç –º—è–≥–∫–æ–π —Å—Ç–∏–º—É–ª—è—Ü–∏–∏. –†–∏—Ç–º–∏—á–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—â—É—â–µ–Ω–∏–µ –ª—ë–≥–∫–æ—Å—Ç–∏ –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è."
    }
}

# ‚úÖ 2. –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Äî –∏–∑ SPORT_PROFILES
CATEGORIES = list(SPORT_PROFILES.keys())

# ‚úÖ 3. –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å
print("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ Zero-Shot –º–æ–¥–µ–ª–∏ (typeform/distilbert-base-uncased-mnli)...")
print("‚ö†Ô∏è  –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∑–∞–π–º—ë—Ç 1‚Äì2 –º–∏–Ω—É—Ç—ã (–º–æ–¥–µ–ª—å ~250 –ú–ë)...")

try:
    classifier = pipeline(
        "zero-shot-classification",
        model="typeform/distilbert-base-uncased-mnli",
        device=-1  # CPU
    )
    MODEL_READY = True
    print("‚úÖ Zero-Shot –º–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!")
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: {e}")
    classifier = None
    MODEL_READY = False

# ‚úÖ 4. –°–æ–∑–¥–∞—ë–º Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
app = Flask(__name__)

# –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
@app.route('/')
def home():
    return render_template('SignSport-1.0.html')

# –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–Ω–∞–ª–∏–∑–∞
@app.route('/analyze-page')
def analyze_page():
    return render_template('neural_network.html')

# Zero-Shot API
@app.route('/api/analyze', methods=['POST'])
def analyze_text():
    if not MODEL_READY:
        return jsonify({
            "success": False,
            "error": "–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä."
        }), 500

    try:
        data = request.get_json()
        report_text = data.get('text', '').strip()

        if not report_text:
            return jsonify({"error": "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞"}), 400

        # –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Zero-Shot
        result = classifier(report_text, CATEGORIES)
        top_category = result['labels'][0]
        confidence = round(result['scores'][0], 3)

        # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º SPORT_PROFILES, –∞ –Ω–µ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        rec = SPORT_PROFILES[top_category]

        return jsonify({
            "success": True,
            "category": top_category,
            "confidence": confidence,
            "sport": rec["sport"],
            "reason": rec["reason"]
        })

    except Exception as e:
        return jsonify({"error": f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"}), 500

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
if __name__ == '__main__':
    print("\n" + "="*50)
    print("‚úÖ SignSport –∑–∞–ø—É—â–µ–Ω!")
    print("üëâ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: http://localhost:5000")
    print("="*50 + "\n")
    app.run(debug=True, host='0.0.0.0', port=5000)