from flask import Flask, request, jsonify, render_template
import os

os.environ["TOKENIZERS_PARALLELISM"] = "false"

# === 1. –°–ü–ò–°–û–ö –í–ò–î–û–í –°–ü–û–†–¢–ê (–∏–∑ —Ç–≤–æ–µ–π —Ç–∞–±–ª–∏—Ü—ã) ===
SPORT_CATEGORIES = [
    "–§—É—Ç–±–æ–ª",
    "–ì–∞–Ω–¥–±–æ–ª",
    "–í–æ–¥–Ω–æ–µ –ø–æ–ª–æ",
    "–í–æ–ª–µ–π–±–æ–ª",
    "–ü–ª–∞–≤–∞–Ω–∏–µ",
    "–§–∏–≥—É—Ä–Ω–æ–µ –∫–∞—Ç–∞–Ω–∏–µ",
    "–¢—è–∂—ë–ª–∞—è –∞—Ç–ª–µ—Ç–∏–∫–∞",
    "–ë–æ–ª—å—à–æ–π —Ç–µ–Ω–Ω–∏—Å",
    "–•–æ–∫–∫–µ–π",
    "–§–µ—Ö—Ç–æ–≤–∞–Ω–∏–µ",
    "–ê–∫—Ä–æ–±–∞—Ç–∏–∫–∞",
    "–®–∞—Ö–º–∞—Ç—ã",
    "–ë–æ–∫—Å"
]

# === 2. –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò ===
print("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ rubert-tiny2...")
try:
    from transformers import (
        AutoTokenizer,
        AutoModelForSequenceClassification,
        pipeline
    )
    
    # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
    if os.path.exists("signsport-model"):
        print("üìÇ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å...")
        classifier = pipeline(
            "text-classification",
            model="signsport-model",
            tokenizer="signsport-model"
        )
        MODEL_TYPE = "fine-tuned"
    else:
        # Fallback: Zero-Shot –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º (–Ω–æ —Å —Ä—É—Å—Å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º)
        print("‚ö†Ô∏è –î–æ–æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ–º Zero-Shot...")
        classifier = pipeline(
            "zero-shot-classification",
            model="MoritzLaurer/deberta-v3-base-mnli-fever-anli"
        )
        MODEL_TYPE = "zero-shot"
    
    MODEL_READY = True
    print("‚úÖ –ú–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!")
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: {e}")
    MODEL_READY = False
    classifier = None
    MODEL_TYPE = None

# === 3. FLASK-–ü–†–ò–õ–û–ñ–ï–ù–ò–ï ===
app = Flask(__name__)

@app.route('/')
def home():
    return render_template('SignSport-1.0.html')

@app.route('/analyze')
def analyze():
    return render_template('analyze.html')

@app.route('/api/analyze', methods=['POST'])
def analyze_text():
    if not MODEL_READY:
        return jsonify({
            "success": False,
            "error": "–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä."
        }), 500

    try:
        data = request.get.json()
        text = data.get('text', '').strip()
        if not text:
            return jsonify({"error": "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞"}), 400

        if MODEL_TYPE == "fine-tuned":
            # –î–æ–æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å ‚Äî –ø—Ä—è–º–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
            result = classifier(text)
            sport = result[0]['label']
        else:
            # Zero-Shot ‚Äî —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            en_labels = [
                "football", "handball", "water polo", "volleyball", "swimming",
                "figure skating", "weightlifting", "tennis", "ice hockey",
                "fencing", "acrobatics", "chess", "boxing"
            ]
            result = classifier(text, en_labels)
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∞–Ω–≥–ª–∏–π—Å–∫—É—é –º–µ—Ç–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ä—É—Å—Å–∫—É—é
            en_label = result['labels'][0]
            sport = SPORT_CATEGORIES[en_labels.index(en_label)]

        # –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏–∑ —Ç–≤–æ–µ–π –±–∞–∑—ã
        REASONS = {
            "–§—É—Ç–±–æ–ª": "–û–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è, —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –ø–æ–±–µ–¥–µ –∏ –∫–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî –æ—Å–Ω–æ–≤–∞ —É—Å–ø–µ—Ö–∞ –≤ —Ñ—É—Ç–±–æ–ª–µ.",
            "–ì–∞–Ω–¥–±–æ–ª": "–≠–Ω–µ—Ä–≥–∏—á–Ω–æ—Å—Ç—å, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å, –ª–æ–≤–∫–æ—Å—Ç—å –∏ —É–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ –¥–µ–ª–∞—é—Ç –≥–∞–Ω–¥–±–æ–ª –∏–¥–µ–∞–ª—å–Ω—ã–º –≤—ã–±–æ—Ä–æ–º.",
            "–í–æ–¥–Ω–æ–µ –ø–æ–ª–æ": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ö–ª–∞–¥–Ω–æ–∫—Ä–æ–≤–∏–µ –≤ —Å—Ç—Ä–µ—Å—Å–µ, –≤—ã—Å–æ–∫–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –∏ —Ç–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.",
            "–í–æ–ª–µ–π–±–æ–ª": "–ë—ã—Å—Ç—Ä–æ—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å ‚Äî –æ—Å–Ω–æ–≤–∞ –≤–æ–ª–µ–π–±–æ–ª—å–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞.",
            "–ü–ª–∞–≤–∞–Ω–∏–µ": "–ò–Ω—Ç—Ä–æ–≤–µ—Ä—Å–∏—è, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –º–æ–Ω–æ—Ç–æ–Ω–∏–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç–º ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø–ª–∞–≤–∞–Ω–∏—è.",
            "–§–∏–≥—É—Ä–Ω–æ–µ –∫–∞—Ç–∞–Ω–∏–µ": "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ —Ä–∏—Ç—É–∞–ª–∞–º –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.",
            "–¢—è–∂—ë–ª–∞—è –∞—Ç–ª–µ—Ç–∏–∫–∞": "–°–∏–ª–∞ –≤–æ–ª–∏, —Ç–µ—Ä–ø–µ–ª–∏–≤–æ—Å—Ç—å, –º–µ—Ç–æ–¥–∏—á–Ω–æ—Å—Ç—å –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ –ª–∏—á–Ω–æ–µ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ ‚Äî –æ—Å–Ω–æ–≤–∞ —É—Å–ø–µ—Ö–∞.",
            "–ë–æ–ª—å—à–æ–π —Ç–µ–Ω–Ω–∏—Å": "–≠–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è, —Ç–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –ø–æ–±–µ–¥–µ.",
            "–•–æ–∫–∫–µ–π": "–°–º–µ–ª–æ—Å—Ç—å, —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∫–æ–ª–ª–µ–∫—Ç–∏–≤–∏–∑–º –∏ —É–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —É—Å–ª–æ–≤–∏—è—Ö –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è.",
            "–§–µ—Ö—Ç–æ–≤–∞–Ω–∏—è": "–ê–Ω–∞–ª–∏—Ç–∏—á–Ω–æ—Å—Ç—å, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, –±—ã—Å—Ç—Ä–æ—Ç–∞ —Ä–µ–∞–∫—Ü–∏–∏ –∏ —É–º–µ–Ω–∏–µ –ø—Ä–æ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ö–æ–¥—ã —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.",
            "–ê–∫—Ä–æ–±–∞—Ç–∏–∫–∞": "–ê—Ä—Ç–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –≤—ã—Å–æ–∫–∞—è –≤–µ—Å—Ç–∏–±—É–ª—è—Ä–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.",
            "–®–∞—Ö–º–∞—Ç—ã": "–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, –∞–Ω–∞–ª–∏—Ç–∏—á–Ω–æ—Å—Ç—å, —É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω–æ—Å—Ç—å –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –≥–ª—É–±–æ–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É.",
            "–ë–æ–∫—Å": "–ò–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—å, —ç–Ω–µ—Ä–≥–∏—è, —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–≥—Ä–µ—Å—Å–∏—é –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–µ —Ä—É—Å–ª–æ."
        }

        reason = REASONS.get(sport, "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –≤–∞—à–µ–≥–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.")

        return jsonify({
            "success": True,
            "sport": sport,
            "reason": reason
        })

    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    print("\n" + "="*50)
    print("‚úÖ SignSport –∑–∞–ø—É—â–µ–Ω!")
    print("üëâ –û—Ç–∫—Ä–æ–π—Ç–µ: http://localhost:5000")
    print("="*50 + "\n")
    app.run(debug=True, host='0.0.0.0', port=5000)