from flask import Flask, request, jsonify, render_template
import os

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–µ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤ –≤ Flask
os.environ["TOKENIZERS_PARALLELISM"] = "false"

# –°–ø–∏—Å–æ–∫ –≤–∏–¥–æ–≤ —Å–ø–æ—Ä—Ç–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
SPORT_CATEGORIES = [
    "–§—É—Ç–±–æ–ª", "–ì–∞–Ω–¥–±–æ–ª", "–í–æ–¥–Ω–æ–µ –ø–æ–ª–æ", "–í–æ–ª–µ–π–±–æ–ª", "–ü–ª–∞–≤–∞–Ω–∏–µ",
    "–§–∏–≥—É—Ä–Ω–æ–µ –∫–∞—Ç–∞–Ω–∏–µ", "–¢—è–∂–µ–ª–∞—è –∞—Ç–ª–µ—Ç–∏–∫–∞", "–¢–µ–Ω–Ω–∏—Å",
    "–•–æ–∫–∫–µ–π", "–§–µ—Ö—Ç–æ–≤–∞–Ω–∏–µ", "–ê–∫—Ä–æ–±–∞—Ç–∏–∫–∞", "–®–∞—Ö–º–∞—Ç—ã", "–ë–æ–∫—Å"
]

print("üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...")
classifier = None
MODEL_READY = False

try:
    from transformers import pipeline

    # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
    if os.path.exists("signsport-model") and os.path.isdir("signsport-model"):
        classifier = pipeline("text-classification", model="signsport-model")
        MODEL_READY = True
        print("‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ–æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∏–∑ –ø–∞–ø–∫–∏ 'signsport-model'")
    else:
        # Fallback: –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è zero-shot –º–æ–¥–µ–ª—å
        print("‚ö†Ô∏è –î–æ–æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ó–∞–≥—Ä—É–∑–∫–∞ –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ–π zero-shot –º–æ–¥–µ–ª–∏...")
        classifier = pipeline(
            "zero-shot-classification",
            model="MoritzLaurer/mDeBERTa-v3-base-xnli-multilingual-nli"
        )
        MODEL_READY = True
        print("‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è zero-shot –º–æ–¥–µ–ª—å (—Ä—É—Å—Å–∫–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)")

except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏: {e}")
    MODEL_READY = False
    classifier = None

# ================ –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ö–û–î–ê ================

def get_diversified_recommendations(text, top_n=3):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    """
    if not MODEL_READY or classifier is None:
        return None
    
    # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    sport_categories_map = {
        "–í–æ–¥–Ω—ã–µ": ["–ü–ª–∞–≤–∞–Ω–∏–µ", "–í–æ–¥–Ω–æ–µ –ø–æ–ª–æ"],
        "–ö–æ–º–∞–Ω–¥–Ω—ã–µ": ["–§—É—Ç–±–æ–ª", "–í–æ–ª–µ–π–±–æ–ª", "–ì–∞–Ω–¥–±–æ–ª", "–•–æ–∫–∫–µ–π"],
        "–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ": ["–®–∞—Ö–º–∞—Ç—ã", "–§–µ—Ö—Ç–æ–≤–∞–Ω–∏–µ"],
        "–°–∏–ª–æ–≤—ã–µ": ["–¢—è–∂–µ–ª–∞—è –∞—Ç–ª–µ—Ç–∏–∫–∞"],
        "–ê—Ä—Ç–∏—Å—Ç–∏—á–Ω—ã–µ": ["–§–∏–≥—É—Ä–Ω–æ–µ –∫–∞—Ç–∞–Ω–∏–µ", "–ê–∫—Ä–æ–±–∞—Ç–∏–∫–∞"],
        "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ": ["–¢–µ–Ω–Ω–∏—Å", "–ë–æ–∫—Å"]
    }
    
    try:
        # –î–ª—è –¥–æ–æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        if os.path.exists("signsport-model") and os.path.isdir("signsport-model"):
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
            predictions = []
            for sport in SPORT_CATEGORIES:
                try:
                    result = classifier(text, candidate_labels=[sport])
                    predictions.append({
                        "sport": sport,
                        "confidence": round(result['scores'][0] * 100, 1)
                    })
                except:
                    predictions.append({
                        "sport": sport,
                        "confidence": 0.0
                    })
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
            predictions.sort(key=lambda x: x["confidence"], reverse=True)
            
        # –î–ª—è zero-shot –º–æ–¥–µ–ª–∏
        else:
            result = classifier(text, candidate_labels=SPORT_CATEGORIES)
            predictions = []
            for label, score in zip(result['labels'], result['scores']):
                predictions.append({
                    "sport": label,
                    "confidence": round(score * 100, 1)
                })
        
        # –î–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        selected_sports = []
        selected_categories = []
        diversified_results = []
        
        for pred in predictions:
            if len(diversified_results) >= top_n:
                break
                
            sport = pred["sport"]
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            sport_category = None
            for category, sports in sport_categories_map.items():
                if sport in sports:
                    sport_category = category
                    break
            if sport_category is None:
                sport_category = "–î—Ä—É–≥–∏–µ"
            
            # –ï—Å–ª–∏ —ç—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º
            if sport_category not in selected_categories:
                diversified_results.append(pred)
                selected_sports.append(sport)
                selected_categories.append(sport_category)
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞–±—Ä–∞–ª–∏ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –¥–æ–±–∞–≤–ª—è–µ–º —Å–∞–º—ã–µ —É–≤–µ—Ä–µ–Ω–Ω—ã–µ
        if len(diversified_results) < top_n:
            for pred in predictions:
                if len(diversified_results) >= top_n:
                    break
                if pred["sport"] not in selected_sports:
                    diversified_results.append(pred)
                    selected_sports.append(pred["sport"])
        
        return diversified_results
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ get_diversified_recommendations: {e}")
        return None

# ================ –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ================

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
app = Flask(__name__)

@app.route('/')
def home():
    return render_template('SignSport-1.0.html')

@app.route('/analyze')
def analyze_page():
    return render_template('neural_network.html')

@app.route('/api/analyze', methods=['POST'])
def analyze_text():
    if not MODEL_READY or classifier is None:
        return jsonify({"error": "–ú–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ."}), 500

    try:
        data = request.get_json()
        text = data.get('text', '').strip()
        if not text:
            return jsonify({"error": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á—ë—Ç–∞."}), 400
        
        # ================ –ò–ó–ú–ï–ù–Ø–ï–ú –≠–¢–£ –ß–ê–°–¢–¨ ================
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ —Å —Ü–µ–ª—å—é –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∏—Å–∫–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        recommendations = get_diversified_recommendations(text, top_n=3)
        
        if not recommendations or len(recommendations) == 0:
            return jsonify({"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"}), 500
        
        # –û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (—Å–∞–º–∞—è —É–≤–µ—Ä–µ–Ω–Ω–∞—è)
        main_recommendation = recommendations[0]
        sport = main_recommendation["sport"]
        confidence = main_recommendation["confidence"]
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        additional_recommendations = []
        if len(recommendations) > 1:
            for i in range(1, len(recommendations)):
                additional_recommendations.append({
                    "sport": recommendations[i]["sport"],
                    "confidence": recommendations[i]["confidence"]
                })
        
        # –ü–æ—è—Å–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞ —Å–ø–æ—Ä—Ç–∞
        REASONS = {
            "–§—É—Ç–±–æ–ª": "–û–±—â–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è, —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –ø–æ–±–µ–¥–µ –∏ –∫–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî –æ—Å–Ω–æ–≤–∞ —É—Å–ø–µ—Ö–∞ –≤ —Ñ—É—Ç–±–æ–ª–µ.",
            "–ì–∞–Ω–¥–±–æ–ª": "–≠–Ω–µ—Ä–≥–∏—á–Ω–æ—Å—Ç—å, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å, –ª–æ–≤–∫–æ—Å—Ç—å –∏ —É–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ –¥–µ–ª–∞—é—Ç –≥–∞–Ω–¥–±–æ–ª –∏–¥–µ–∞–ª—å–Ω—ã–º –≤—ã–±–æ—Ä–æ–º.",
            "–í–æ–¥–Ω–æ–µ –ø–æ–ª–æ": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ö–ª–∞–¥–Ω–æ–∫—Ä–æ–≤–∏–µ –≤ —Å—Ç—Ä–µ—Å—Å–µ, –≤—ã—Å–æ–∫–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –∏ —Ç–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.",
            "–í–æ–ª–µ–π–±–æ–ª": "–ë—ã—Å—Ç—Ä–æ—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å ‚Äî –æ—Å–Ω–æ–≤–∞ –≤–æ–ª–µ–π–±–æ–ª—å–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞.",
            "–ü–ª–∞–≤–∞–Ω–∏–µ": "–ò–Ω—Ç—Ä–æ–≤–µ—Ä—Å–∏—è, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –º–æ–Ω–æ—Ç–æ–Ω–∏–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∏—Ç–º ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø–ª–∞–≤–∞–Ω–∏—è.",
            "–§–∏–≥—É—Ä–Ω–æ–µ –∫–∞—Ç–∞–Ω–∏–µ": "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ —Ä–∏—Ç—É–∞–ª–∞–º –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.",
            "–¢—è–∂–µ–ª–∞—è –∞—Ç–ª–µ—Ç–∏–∫–∞": "–°–∏–ª–∞ –≤–æ–ª–∏, —Ç–µ—Ä–ø–µ–ª–∏–≤–æ—Å—Ç—å, –º–µ—Ç–æ–¥–∏—á–Ω–æ—Å—Ç—å –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ –ª–∏—á–Ω–æ–µ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ ‚Äî –æ—Å–Ω–æ–≤–∞ —É—Å–ø–µ—Ö–∞.",
            "–¢–µ–Ω–Ω–∏—Å": "–≠–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è, —Ç–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –ø–æ–±–µ–¥–µ.",
            "–•–æ–∫–∫–µ–π": "–°–º–µ–ª–æ—Å—Ç—å, —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∫–æ–ª–ª–µ–∫—Ç–∏–≤–∏–∑–º –∏ —É–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —É—Å–ª–æ–≤–∏—è—Ö –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è.",
            "–§–µ—Ö—Ç–æ–≤–∞–Ω–∏–µ": "–ê–Ω–∞–ª–∏—Ç–∏—á–Ω–æ—Å—Ç—å, —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å, –±—ã—Å—Ç—Ä–æ—Ç–∞ —Ä–µ–∞–∫—Ü–∏–∏ –∏ —É–º–µ–Ω–∏–µ –ø—Ä–æ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ö–æ–¥—ã —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.",
            "–ê–∫—Ä–æ–±–∞—Ç–∏–∫–∞": "–ê—Ä—Ç–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –≤—ã—Å–æ–∫–∞—è –≤–µ—Å—Ç–∏–±—É–ª—è—Ä–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.",
            "–®–∞—Ö–º–∞—Ç—ã": "–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, –∞–Ω–∞–ª–∏—Ç–∏—á–Ω–æ—Å—Ç—å, —É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω–æ—Å—Ç—å –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –≥–ª—É–±–æ–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É.",
            "–ë–æ–∫—Å": "–°–º–µ–ª–æ—Å—Ç—å, —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ –∏ —É–º–µ–Ω–∏–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –±—ã—Å—Ç—Ä—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º.",
        }

        reason = REASONS.get(sport, "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –≤–∞—à–µ–º –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø—Ä–æ—Ñ–∏–ª–µ.")

        return jsonify({
            "success": True,
            "sport": sport,
            "confidence": confidence,
            "reason": reason,
            "additional_recommendations": additional_recommendations
        })
        # ================ –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ================

    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        print(f"–û—à–∏–±–∫–∞ –≤ /api/analyze: {e}")
        return jsonify({"error": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–µ–∫—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."}), 500

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if __name__ == '__main__':
    print("\n" + "="*50)
    status = "‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!" if MODEL_READY else "‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!"
    print(f"üß† SignSport Neural Network ‚Äî {status}")
    print("üëâ –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:5000")
    print("="*50 + "\n")
    app.run(debug=True, host='0.0.0.0', port=5000)